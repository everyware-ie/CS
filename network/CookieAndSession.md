# 쿠키와 세션

HTTP 프로토콜의 특성이자 약점을 보완하기 위해서 쿠키 또는 세션을 사용

기본적으로 HTTP 프로토콜 환경은 connectionless, stateless 한 특성을 가지기 때문에 서버는 클라이언트가 누구인지 매번 확인해야함. 이 특성을 보완하기 위해서 쿠키와 세션을 사용하게됨.

- connectionless
    
    → 클라이언트가 요청을 한 후 응답을 받으면 그 연결을 끊어버리는 특징
    
    HTTP는 먼저 클라이언트가 request를 서버에 보내면, 서버는 클라이언트에게 요청에 맞는 response를 보내고 접속을 끊는 특성이 있음.
    
- stateless
    
    통신이 끝나면 상태를 유지하지 않는 특징
    
    연결을 끊는 순간 클라이언트와 서버의 통신이 끝나며 상태 정보는 유지하지 않는 특성이 있음.
    

쿠키와 세션은 위의 두 가지 특징을 해결하기 위해 사용

예를 들어, 쿠키와 세션을 사용하지 않으면 쇼핑몰에서 옷을 구매하려고 로그인을 했음에도, 페이지를 이동할 때마다 계속 로그인을 해야함.

쿠키와 세션을 사용했을 경우, 한 번 로그인을 하면 어떠한 방식에 의해서 그 사용자에 대한 인증을 유지하기 됨.

## 쿠키

### 쿠키란

- 쿠키는 클라이언트(브라우저) 로컬에 저장되는 키와 값이 들어있는 작은 데이터 파일
- 사용자 인증이 유효한 시간을 명시할 수 있으며, 유효 시간이 정해지면 브라우저가 종료되어도 인증이 유지된다는 특징이 있음
- 쿠키는 클라이언트의 상태 정보를 로컬에 저장했다가 참조함
- 클라이언트에 300개까지 쿠키 저장 가능, 하나의 도메인당 20개의 값만 가질 수 있음, 하나의 쿠키값은 4KB까지 저장
- Response 헤더에 Set-Cookie 속성을 사용하면 클라이언트에 쿠키를 만들 수 있음
- 쿠키는 사용자가 따로 요청하지 않아도 브라우저가 request할 때 request 헤더를 넣어서 자동으로 서버에 전송

→ 쿠키는 크롬이나 사파리 같은 브라우저에 저장되는 작은 텍스트 조각. 브라우저는 사용자의 컴퓨터에 설치된 소프트웨어이므로 쿠키는 사용자가 가지고 있는 정보라고 할 수 있음.

사용자는 브라우저의 설정 화면이나 개발자 도구에서 쿠키를 확인하고 수정, 삭제할 수 있음. 쿠키는 당사자뿐만 아니라 제 3자가 조회하는 것도 가능하기 때문에 개인 정보를 담은 내용이나 보안상 민감한 정보를 저장하는 데에는 적합하지 않음.

### 쿠키의 구성 요소

- 이름: 각각의 쿠키를 구별하는 데 사용되는 이름
- 값: 쿠키의 이름과 관련된 값
- 유효시간: 쿠키의 유지시간
- 도메인: 쿠키를 전송할 도메인
- 경로: 쿠키를 전송할 요청 경로

### 쿠키의 동작 방식

1. 클라이언트가 페이지를 요청
2. 서버에서 쿠키를  생성
3. HTTP  헤더에 쿠키를 포함시켜 응답
4. 브라우저가 종료되어도 쿠키 만료 기간이 있다면 클라이언트에서 보관하고 있음
5. 같은 요청을 할 경우 HTTP 헤더에 쿠키를 함께 보냄
6. 서버에서 쿠키를 읽어 이전 상태 정보를 변경할 필요가 있을 때 쿠키를 업데이트하여 변경된 쿠키를 HTTP 헤더에 포함시켜 응답

### 쿠키의 사용 예

- 방문 사이트에서 로그인 시, “아이디와 비밀번호를 저장하시겠습니까?”
- 쇼핑몰의 장바구니 기능(로그인 하지 않아도 )
- 자동로그인, 팝업 → 오늘 더 이상 이 창을 보지 않음 체크 등

## 세션

### 세션이란?

- 세션은 쿠키를 기반하고 있지만, 사용자 정보 파일을 브라우저에 저장하는 쿠키와 달리 세션은 서버 측에서 관리
- 서버에서는 클라이언트를 구분하기 위해 세션 ID를 부여하며 웹 브라우저가 서버에 접속해서 브라우저를 종료할 때까지 인증상태를 유지함
- 접속 시간에 제한을 두어 일정 시간 응답이 없다면 정보가 유지되지 않게 설정이 가능
- 사용자에 대한 정보를 서버에 두기 때문에 쿠키보다 보안에 좋지만, 사용자가 많아질수록 서버 메모리를 많이 차지하게 됨
- 즉 동접자 수가 많은 웹 사이트인 경우 서버에 과부하를 주게 되므로 성능 저하의 요인이 됨
- 클라이언트가 request를 보내면, 해당 서버의 엔진이 클라이언트에게 유일한 ID를 부여하는 데 이것이 세션 ID

→ 웹 사이트에 아이디와 비밀번호를 입력해서 로그인하면 해당 사이트의 회원에게만 허용된 기능들을 사용할 수 있음. 마이페이지를 클릭해서 내 정보를 볼 수 있고, 회원 전용 게시판의 글쓰기 버튼을 클릭해서 질문을 남기거나 리뷰를 쓸 수도 있음.

문제는 이와 같은 클릭 하나하나는 매번 서버에게 새로 보내는 익명 편지와도 같아서 사이트에 로그인을 하는 등의 이전 행동들과 연결되어 있지 않음. 따라서 서버는 아이디와 비번을 입력해 로그인에 성공한 사용자와 로그인한 다음 마이페이지 버튼을 누른 사용자가 동일 인물임을 알지 못한다는 것. 그렇기 때문에 사용자가 사이트에 로그인한 상태라는 점을 서버에 인증하지 못하면 클릭할 때마다 반복해서 아이디와 비밀번호를 서버에 제공해야 함. 이런 번거로움을 해결하기 위해 사용하는 것이 바로 세션

### 세션의 동작 방식

1. 클라이언트가 서버에 접속 시 세션 ID를 발급 받음
2. 클라이언트는 세션 ID에 대해 쿠키를 사용해서 저장하고 가지고 있음
3. 클라이언트는 서버에 요청할 때, 이 쿠키의 세션 ID를 같이 서버에 전달해서 요청
4. 서버는 세션 ID를 전달 받아서 별다른 작업없이 세션 ID로 세션에 있는 클라이언트 정보를 가져와서 사용
5. 클라이언트 정보를 가지고 서버 요청을 처리하여 클라이언트에게 응답

### 세션의 특징

- 각 클라이언트에게 고유 ID를 부여
- 세션 ID로 클라이언트를 구분해서 클라이언트의 요구에 맞는 서비스 제공
- 보안 면에서 쿠키보다 우수
- 사용자가 많아질수록 서버 메모리를 많이 차지

### 세션 사용의 예

- 로그인 같이 보안상 중요한 작업을 수행할 때 사용

## 쿠키와 세션의 차이

- 쿠키와 세션은 비슷한 역할을 하며, 동작원리도 비슷함. 그 이유는 세션도 결국 쿠키를 사용하기 때문
- 가장 큰 차이점은 사용자의 정보가 저장되는 위치. 쿠키는 서버의 자원을 전혀 사용하지 않으며, 세션은 서버의 자원을 사용함
- 쿠키는 클라이언트 로컬에 저장되기 때문에 변질되거나 request에서 스니핑 당할 우려가 있기 때문에 보안에 취약하지만 세션은 쿠키를 이용해서 세션 ID만을 저장하고 그것으로 구분해서 서버에서 처리하기 때문에 비교적 보안성이 좋음
- 쿠키도 만료시간이 있지만 파일로 저장되기 때문에 브라우저를 종료해도 계속해서 정보가 남아 있을 수 있음. 또한 만료기간을 넉넉하게 잡아두면 쿠키 삭제시까지 유지될 수 있음.
- 반면에 세션도 만료시간을 정할 수 있지만 브라우저가 종료되면 만료시간에 상관없이 삭제됨. 예를 들어, 크롬에서 다른 탭을 사용해도 세션이 공유됨. 다른 브라우저를 사용하게 되면 다른 세션이 사용됨
- 쿠키에 정보가 있기 때문에 서버에 요청 시 속도가 빠르고 세션은 정보가 서버에 있기 때문에 처리가 요구되어 비교적 느린 속도를 가짐.

### 세션이 더 좋아보이는데 쿠키를 사용하는 이유

- 세션은 서버의 자원을 사용하기 때문에 무분별하게 만들다보면 서버의 메모리가 감당할 수 없어지고, 속도가 느려질 수 있기 때문에 쿠키가 유리한 경우가 있음.

## 토큰

### 토큰이란

세션 방식은 안전하고 효과적이지만 단점도 있음. 서버는 요청마다 함께 딸려 오는 세션 아이디를 바로바로 확인할 수 있도록 로그인한 사용자의 아이디를 메모리에 올려둠. 메모리에 올려둔 데이터를 빠르게 확인할 수 있다는 장점이 있는 대신 공간이 한정되어 있음. 서버에 동시 접속하는 사용자가 많아지면 메모리 공간이 부족해져서 서버에 부하가 걸리고 화면이 움직이지 않는 등의 문제가 발생할 수 있음.

그래서 세션 대신 토큰을 발급해 주는 것. 이러한 토큰에는 특수한 수학적 원리가 적용되어 있어서 마치 위조 방지 장치가 있는 지폐처럼 서버만이 유효한 토큰을 발행할 수 있음.

그렇기 때문에 토큰을 받아간 사용자가 이를 쿠키로 저장해 두고 필요할 때마다 제시하면 서버는 따로 메모리를 확인할 필요 없이 자기가 발급한 토큰임을 알아보고 사용자의 요청을 허가해 줌. 따라서 더이상 메모리에 사용자 아이디를 올려 두고 있을 필요가 없으니 서버 부하를 줄일 수 있음.

### 한계점

물론 토큰 방식에도 한계는 있음. 여러 기기에서의 로그인을 제한하기 위해 필요한 때에 로그인되어 있는 사용자를 서버가 강제로 로그아웃 시킬 수 있어야 하는데, 토큰 방식에서는 이것이 불가능함. 한 번 발행한 토큰은 유효기간이 끝나기 전까지 따로 통제할 수 없기 때문에 세션에 비해 토큰 정보를 탈취 당할 가능성이 높음. 그러나 토큰은 쿠키처럼 만료 기간을 정할 수 있어서 만료 시간을 짧게 지정해 피해를 줄일 수 있음.

### JWT (Json Web Token)

JSON 자료구조를 가지고 있으며, Web Token으로써 사용할 수 있다는 의미.

JSON은 Key, Value가 한 쌍을 이루는 객체를 말함. JWT에서는 name, value의 한 쌍이라고 함.

### JWT 사용 이유

HTTP는 기본적으로 state-less(서버가 클라이언트의 상태를 가지고 있지 않는 것)를 지향함.

- 장점: 서버의 확장성이 높으며 대량의 트래픽이 발생해도 대처할 수 있음
- 단점: state-ful 방식보다 비교적 많은 양의 데이터가 반복적으로 전송되므로 네트워크 성능저하가 될 수 있음, 데이터 노출로 인한 보안적인 문제

→ 이러한 단점을 보완하기 위해 JWT로 데이터 압축 및 암호화를 위하여 사용

### JWT의 구성

헤더, 페이로드 ,시그니처로 이루어짐.

- 헤더: 토큰 타입, 암호화 알고리즘 명시
- 페이로드: JWT에 넣을 데이터, JWT 발급 / 만료일 등 명시
- 시그니처: 헤더, 페이로드가 변조 되었는지를 확인하는 역할

### 세션 vs 토큰

- 일반적으로 보안성 성능 면에서는 세션이 더 좋음. 비용, 서버 부하, 확장성 면에서는 토큰이 더 좋음

## 쿠키/세션 vs 캐시

### 캐시(cashe)

우리는 매일같이 웹사이트나 유튜브, 올라인 게임 등을 통해 이미지, 동영상, 웹 페이지 코드와 같은 대량의 데이터를 서버로부터 전송받음. 이러한 데이터 전송에는 시간이 소요될 뿐만 아니라 통신비도 지출됨. 고화질 동영상처럼 크기가 큰 데이터일수록 비용은 더욱 커짐.

그러나 한 번 전송받은 데이터는 저장해 두었다가 다시 사용할 때 꺼내쓴다면 반복적으로 서버에 데이터 전송을 요청할 필요가 없음. 이때 사용되는 기술이 캐시. 캐시 덕분에 우리는 반복적으로 사용하는 컨텐츠를 빠르게 이용할 수 있고 데이터 사용량도 줄일 수 있음.

→ 캐시는 인터넷 환경뿐만 아니라 다양한 곳에서 사용되는 개념. 컴퓨터의 하드웨어 안에서도 메모리 안에 들어있는 정보를 더 빨리 가져올 수 있도록 하는 CPU 캐시 등이 있음.

### 쿠키와 캐시의 차이

|  | 캐시 | 쿠키 |
| --- | --- | --- |
| 정의 | 캐시는 웹 페이지 요소를 저장하기 위한 임시 저장소. 특히, 후에 필요할 것 같은 요소들을 저장함. 이러한 요소들은 그림 파일이나 문서 파일 등 | 쿠키는 정보를 저장하기 위해 사용됨. 기본적으로 웹 서버에서 PC로 보내는 작은 파일들을 저장. 보통 쿠키는 누군가 특정한 웹 사이트를 접속할 때 발생 |
| 목적 | 캐시는 웹 페이지가 빠르게 렌더링 할 수 있도록 도와줌 | 쿠키는 사용자의 인증을 도와줌 |
| 삭제 | 사용자가 직접 수동으로 삭제해주어야 함 | 만료기간이 있어 시간이 지나면 자동 삭제됨 |
| 예시 | 오디오, 비디오 파일 등 | 유저의 선호도(로그인 정보, 방문 기록, 방문횟수) |

→ 쿠키와 캐시 모두 정보를 저장하여 재활용하는 기술이지만, 쿠키는 사용자의 수고를 덜어주는 데 목적을 두고 캐시는 데이터의 전송량을 줄이고 서비스 이용 속도를 높이는 데 목적을 둠.